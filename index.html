<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Chatbot ‚Äì GitHub Pages + Power Automate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#f6f7f9;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#111827;   /* negro */
      --card:#ffffff;
      --line:#e5e7eb;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0e14; --ink:#e5e7eb; --muted:#9aa3b2; --brand:#e5e7eb; --card:#141820; --line:#222633;
      }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    main{padding:24px; max-width:900px; margin:auto}
    h1{margin:16px 0 8px}
    p{color:var(--muted)}
    /* Bot√≥n flotante */
    .chat-launcher{
      position:fixed; right:20px; bottom:20px; z-index:9999;
      background:var(--brand); color:#0b0e14; border:none; border-radius:999px;
      width:56px; height:56px; display:grid; place-items:center; box-shadow:0 10px 20px rgba(0,0,0,.15); cursor:pointer; font-size:22px;
    }
    @media (prefers-color-scheme: dark){
      .chat-launcher{ color:#0b0e14; background:#e5e7eb }
    }
    .chat-panel{
      position:fixed; right:20px; bottom:90px; width:360px; max-width:92vw; height:560px; max-height:75vh;
      background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 24px 48px rgba(0,0,0,.28);
      display:none; flex-direction:column; overflow:hidden; z-index:9998;
    }
    .chat-header{
      padding:12px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px; background:var(--card)
    }
    .dot{width:10px; height:10px; background:#22c55e; border-radius:50%}
    .title{font-weight:700}
    .chat-body{padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; background:linear-gradient(var(--card), rgba(0,0,0,0.01))}
    .msg{max-width:85%; padding:10px 12px; border-radius:14px; line-height:1.35; white-space:pre-wrap; word-wrap:break-word}
    .msg.user{margin-left:auto; background:#111827; color:#fff; border-top-right-radius:4px}
    .msg.bot{margin-right:auto; background:#f3f4f6; color:#111827; border-top-left-radius:4px; border:1px solid #e5e7eb}
    @media (prefers-color-scheme: dark){
      .msg.user{background:#e5e7eb;color:#0b0e14}
      .msg.bot{background:#0f1420;color:#e5e7eb;border-color:#1e2433}
    }
    .chat-input{border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; background:var(--card)}
    .chat-input input{
      flex:1; padding:12px 12px; border:1px solid var(--line); border-radius:12px; outline:none; background:transparent; color:inherit
    }
    .chat-input button{
      background:var(--brand); color:#0b0e14; border:none; border-radius:12px; padding:0 14px; cursor:pointer; min-width:84px; height:44px; font-weight:700;
    }
    @media (prefers-color-scheme: dark){
      .chat-input button{ background:#e5e7eb; color:#0b0e14 }
    }
    .hint{font-size:12px; color:var(--muted); padding:0 12px 8px}
    .badge{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted)}
    @media (max-width:480px){
      .chat-panel{right:10px; left:10px; width:auto; height:70vh}
    }
    .hidden{display:none}
  </style>
</head>
<body>
  <main>
    <h1>Chatbot conectado a Power Automate</h1>
    <p>Publica este archivo en GitHub Pages y pulsa el bot√≥n üí¨ para probar el chat.</p>
    <span class="badge">GitHub Pages compatible</span>
  </main>

  <!-- Chat flotante -->
  <button class="chat-launcher" aria-label="Abrir chat" id="openChat">üí¨</button>
  <section class="chat-panel" id="chatPanel" role="dialog" aria-label="Asistente virtual" aria-modal="true">
    <header class="chat-header">
      <span class="dot" aria-hidden="true"></span>
      <div>
        <div class="title">Asistente</div>
        <div class="hint">Conectado a tu flujo de Power Automate</div>
      </div>
      <button id="closeChat" style="margin-left:auto;background:transparent;border:none;font-size:20px;cursor:pointer" aria-label="Cerrar">‚úï</button>
    </header>

    <div class="chat-body" id="chatBody" tabindex="0" aria-live="polite"></div>
    <div class="chat-input">
      <input id="userInput" type="text" placeholder="Escribe tu pregunta‚Ä¶" autocomplete="off" />
      <button id="sendBtn">Enviar</button>
    </div>
  </section>

  <script>
    // === URL del disparador HTTP (la tuya) ===
    const FLOW_URL = 'https://black-wood-6868.jeystore24.workers.dev/';

    // ==== Utilidades de UI ====
    const $ = s => document.querySelector(s);
    const chatPanel = $('#chatPanel');
    const openBtn   = $('#openChat');
    const closeBtn  = $('#closeChat');
    const chatBody  = $('#chatBody');
    const input     = $('#userInput');
    const sendBtn   = $('#sendBtn');

    // UUID v4 simple
    function uuid(){
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }
    let sessionId = localStorage.getItem('chat_session_id');
    if(!sessionId){
      sessionId = uuid();
      localStorage.setItem('chat_session_id', sessionId);
    }

    const STORAGE_KEY = 'chat_history';
    const history = (()=>{
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch{ return []; }
    })();

    function saveHistory(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    function renderMessage(msg){
      const el = document.createElement('div');
      el.className = `msg ${msg.role === 'user' ? 'user' : 'bot'}`;
      el.textContent = msg.content;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function renderWelcome(){
      if(history.length === 0){
        const welcome = { role:'assistant', content:'¬°Hola! Soy tu asistente. ¬øEn qu√© puedo ayudarte hoy?' };
        history.push(welcome); renderMessage(welcome); saveHistory();
      }else{
        history.forEach(renderMessage);
      }
    }

    // Eventos UI
    openBtn.onclick = () => { chatPanel.style.display='flex'; setTimeout(()=>input.focus(), 50); };
    closeBtn.onclick = () => { chatPanel.style.display='none'; };
    input.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); send(); }});
    sendBtn.onclick = send;

    renderWelcome();

    // Indicador de "escribiendo‚Ä¶"
    function showTyping(){
      const el = document.createElement('div');
      el.className = 'msg bot typing';
      el.textContent = 'Escribiendo‚Ä¶';
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
      return el;
    }
    function replaceTyping(el, text){
      el.textContent = text;
      el.classList.remove('typing');
    }

    async function send(){
      const content = input.value.trim();
      if(!content) return;
      input.value=''; input.disabled = true; sendBtn.disabled = true;

      const userMsg = { role:'user', content };
      history.push(userMsg); renderMessage(userMsg); saveHistory();

      const typingEl = showTyping();

      // Evitar cuelgues eternos
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);

      try{
        const res = await fetch(FLOW_URL, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-store',
          headers: {
            'Content-Type': 'application/json; charset=utf-8',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            session_id: sessionId,
            message_text: content
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if(!res.ok){
          let hint = '';
          if(res.status === 401 || res.status === 403) hint = ' (¬øfirma ?sig vencida o inv√°lida?)';
          if(res.status === 404) hint = ' (¬øruta del disparador incorrecta?)';
          const txt = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status}${hint}. Respuesta: ${txt || '(vac√≠a)'}`);
        }

        const ct = res.headers.get('content-type') || '';
        let botText = '';
        if(ct.includes('application/json')){
          const data = await res.json().catch(()=> ({}));
          botText = (typeof data.reply === 'string') ? data.reply
                   : (typeof data.body  === 'string') ? data.body
                   : JSON.stringify(data, null, 2);
        }else{
          botText = await res.text();
        }
        if(!botText) botText = 'No pude procesar la respuesta.';

        replaceTyping(typingEl, botText);
        history.push({ role:'assistant', content: botText }); saveHistory();

      }catch(err){
        console.error(err);
        const msg = '‚ö†Ô∏è Error al conectar con el flujo.\n' +
          '‚Ä¢ Verifica que la URL del disparador sea la m√°s reciente e incluya ?sv=‚Ä¶&sig=‚Ä¶\n' +
          '‚Ä¢ En el flujo, usa el disparador **Solicitud HTTP** con esquema { session_id, message_text }\n' +
          `‚Ä¢ Detalle: ${err.message}`;
        replaceTyping(typingEl, msg);
        history.push({ role:'assistant', content: msg }); saveHistory();
      }finally{
        input.disabled = false; sendBtn.disabled = false; input.focus();
      }
    }
  </script>
</body>
</html>
