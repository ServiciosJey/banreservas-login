<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Chatbot â€“ PÃ¡gina con Power Automate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7f9;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#111827;   /* negro */
      --card:#ffffff;
      --line:#e5e7eb;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    main{padding:24px; max-width:900px; margin:auto}
    /* BotÃ³n flotante */
    .chat-launcher{
      position:fixed; right:20px; bottom:20px; z-index:9999;
      background:var(--brand); color:#fff; border:none; border-radius:999px;
      width:56px; height:56px; display:grid; place-items:center; box-shadow:0 10px 20px rgba(0,0,0,.15); cursor:pointer; font-size:22px;
    }
    .chat-panel{
      position:fixed; right:20px; bottom:90px; width:360px; max-width:92vw; height:560px; max-height:75vh;
      background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 24px 48px rgba(0,0,0,.18);
      display:none; flex-direction:column; overflow:hidden; z-index:9998;
    }
    .chat-header{
      padding:12px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px; background:#fff
    }
    .dot{width:10px; height:10px; background:#22c55e; border-radius:50%}
    .title{font-weight:700}
    .chat-body{padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; background:linear-gradient(#fff, #fafafa)}
    .msg{max-width:85%; padding:10px 12px; border-radius:14px; line-height:1.35; white-space:pre-wrap; word-wrap:break-word}
    .msg.user{margin-left:auto; background:#111827; color:#fff; border-top-right-radius:4px}
    .msg.bot{margin-right:auto; background:#f3f4f6; color:#111827; border-top-left-radius:4px; border:1px solid #e5e7eb}
    .chat-input{border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; background:#fff}
    .chat-input input{
      flex:1; padding:12px 12px; border:1px solid var(--line); border-radius:12px; outline:none;
    }
    .chat-input button{
      background:var(--brand); color:#fff; border:none; border-radius:12px; padding:0 14px; cursor:pointer; min-width:84px; height:44px;
    }
    .hint{font-size:12px; color:var(--muted); padding:0 12px 8px}
    @media (max-width:480px){
      .chat-panel{right:10px; left:10px; width:auto; height:70vh}
    }
  </style>
</head>
<body>
  <main>
    <h1>Mi PÃ¡gina con Chatbot</h1>
    <p>Pulsa el botÃ³n ðŸ’¬ para hablar con el asistente.</p>
  </main>

  <!-- Chat flotante -->
  <button class="chat-launcher" aria-label="Abrir chat" id="openChat">ðŸ’¬</button>
  <section class="chat-panel" id="chatPanel" role="dialog" aria-label="Asistente virtual">
    <header class="chat-header">
      <span class="dot" aria-hidden="true"></span>
      <div>
        <div class="title">Asistente</div>
        <div class="hint">Responde dudas sobre esta pÃ¡gina y servicios</div>
      </div>
      <button id="closeChat" style="margin-left:auto;background:transparent;border:none;font-size:20px;cursor:pointer" aria-label="Cerrar">âœ•</button>
    </header>
    <div class="chat-body" id="chatBody" tabindex="0" aria-live="polite"></div>
    <div class="chat-input">
      <input id="userInput" type="text" placeholder="Escribe tu preguntaâ€¦" autocomplete="off" />
      <button id="sendBtn">Enviar</button>
    </div>
  </section>

  <script>
    // === CONFIGURA AQUÃ TU FLUJO ===
    // Usa la URL COMPLETA del disparador (con ?sv=...&sig=...)
    const FLOW_URL = 'https://prod-158.westus.logic.azure.com:443/workflows/6c010744cc764141b69963f91dbcf3ce/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=JhdGkmmxn6SVtJsg_T6Z0GIfcBq1nqs8wu0LGyKSzLQ';

    // === Utilidades bÃ¡sicas ===
    const $ = sel => document.querySelector(sel);
    const chatPanel = $('#chatPanel');
    const openBtn = $('#openChat');
    const closeBtn = $('#closeChat');
    const chatBody = $('#chatBody');
    const input = $('#userInput');
    const sendBtn = $('#sendBtn');

    // Generar/persistir session_id
    function uuid(){return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))}
    let sessionId = localStorage.getItem('chat_session_id') || (() => { const id = uuid(); localStorage.setItem('chat_session_id', id); return id; })();

    // Historial local (para contexto)
    const STORAGE_KEY = 'chat_history';
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch{ return []; }
    }
    function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }

    let history = loadHistory();
    if(history.length === 0){
      const welcome = { role:'assistant', content:'Â¡Hola! Soy tu asistente. Â¿En quÃ© puedo ayudarte hoy?' };
      history.push(welcome); renderMessage(welcome); saveHistory(history);
    }else{
      history.forEach(renderMessage);
    }

    // UI handlers
    openBtn.onclick = () => { chatPanel.style.display='flex'; setTimeout(()=>input.focus(),50); };
    closeBtn.onclick = () => { chatPanel.style.display='none'; };
    input.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); send(); }});
    sendBtn.onclick = send;

    function renderMessage(msg){
      const el = document.createElement('div');
      el.className = `msg ${msg.role === 'user' ? 'user' : 'bot'}`;
      el.textContent = msg.content;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // AnimaciÃ³n de tipeo (sencilla)
    async function typeEffect(text){
      const el = document.createElement('div');
      el.className = 'msg bot';
      chatBody.appendChild(el);
      let i=0;
      return new Promise(resolve=>{
        const step = () => {
          el.textContent = text.slice(0, i+=2);
          chatBody.scrollTop = chatBody.scrollHeight;
          if(i < text.length) requestAnimationFrame(step);
          else resolve();
        };
        requestAnimationFrame(step);
      });
    }

    // Enviar al flujo
    async function send(){
      const content = input.value.trim();
      if(!content) return;
      input.value=''; input.disabled = true; sendBtn.disabled = true;

      const userMsg = { role:'user', content };
      history.push(userMsg); renderMessage(userMsg); saveHistory(history);

      try{
        // Prepara mensajes (Ãºltimos N + system opcional)
        const LAST_N = 10;
        const systemPrompt = { role:'system', content:'Eres un asistente Ãºtil y conciso para una pÃ¡gina web. Si no tienes la respuesta, pÃ­deme mÃ¡s contexto.' };
        // Toma historial sin system y arma payload
        const msgs = [systemPrompt, ...history.filter(m => m.role !== 'system').slice(-LAST_N)];

       const res = await fetch(FLOW_URL, {
  method: 'POST',
  headers: {'Content-Type':'application/json'},
  body: JSON.stringify({
    session_id: sessionId,
    message_text: content   // <-- SOLO el texto actual
  })
});


        if(!res.ok){
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt}`);
        }

        const data = await res.json(); // espera { reply: "..." }
        const botText = (data && typeof data.reply === 'string') ? data.reply : 'No pude procesar la respuesta.';

        const botMsg = { role:'assistant', content: botText };
        history.push(botMsg); saveHistory(history);
        await typeEffect(botText);

      }catch(err){
        console.error(err);
        const botMsg = { role:'assistant', content:'âš ï¸ OcurriÃ³ un error al conectar con el flujo. Verifica la URL del disparador (debe incluir ?sig=...) o CORS.' };
        history.push(botMsg); saveHistory(history); renderMessage(botMsg);
      }finally{
        input.disabled = false; sendBtn.disabled = false; input.focus();
      }
    }
  </script>
</body>
</html>
